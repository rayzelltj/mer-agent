rulebook:
  id: enkel.mer.balance_sheet.review_points
  version: 0.1.0
  title: "Enkel MER — Balance Sheet Review Points"
  source_document: "Best Practice | File Review and Delivery (Balance Sheet review points section)"
  scope:
    statements:
      - balance_sheet
    accounting_systems:
      - quickbooks_online

  policies:
    tolerances:
      symmetric: true
      zero_balance:
        amount: "0.00"
        currency_dependent_rounding: false
      amount_match:
        # Default to exact match unless a client SOP overrides it.
        requires_clarification: false
        default_amount: "0.00"
    explanation_definition:
      # Per your clarification: ANY link OR comment qualifies as explained.
      explained_if_any:
        - comment_present
        - link_present

    lead_flagging_definition:
      # Resolved: lead flags are recorded in the MER Balance Sheet "comments" column.
      detection:
        source: mer_google_sheet
        location: "Balance Sheet tab -> comments column"
        match:
          type: substring
          value: "@lead"
          case_insensitive: true

    capitalization_policy:
      # Resolved: default to $1,000 unless client KYC/SOP overrides.
      default_threshold_amount: 1000
      threshold_currency: "client_base_currency"
      override_precedence:
        - client_maintenance_kyc
        - default
      evidence_required_fields:
        - threshold_amount
        - threshold_source
    source_of_truth_precedence:
      # Per your clarification: MER is the artifact being reviewed.
      # Agent must NOT edit the MER sheet; it cross-checks it against other sources.
      mer_google_sheet:
        role: "review_artifact"
      qbo:
        role: "system_of_record_for_actual_book_balances"
      external_systems:
        role: "supporting_evidence_and_context"

  requires_clarification:
    - id: reconciliation.status_access
      question: "Do you have an API-accessible source for QBO reconciliation status/last reconciled date (or do we treat this as external-only evidence)?"
      status: resolved
      answer: "No QBO reconciliation status endpoint available; reconciliation must be inferred from Google Sheets evidence (MER/reconciliation workpapers) and treated as external evidence."
      needed_for_rules:
        - BS-BANK-RECONCILED-THROUGH-PERIOD-END
        - BS-CC-RECONCILED-THROUGH-PERIOD-END
        - BS-INTERCOMPANY-FORMAL-RECONCILE-IF-EOM-BALANCE

    - id: lead_flagging.definition
      question: "How should the agent detect 'flagged to leads' in reconciliation spreadsheets (e.g., specific column, @mention, owner field)?"
      status: resolved
      answer: "Detect '@lead' (case-insensitive substring match) in the MER Balance Sheet comments column."
      needed_for_rules:
        - BS-UNCLEARED-ITEMS-INVESTIGATED-AND-FLAGGED

    - id: capitalization.threshold_default
      question: "Best Practices says '$1,000' is a good capitalization guide unless advised otherwise. Should the agent default to 1000 when no SOP/KYC threshold is provided, or always require an explicit client threshold?"
      status: resolved
      answer: "Default to $1,000, allow client KYC override, and record threshold source in evidence."
      needed_for_rules:
        - BS-FIXED-ASSET-CAPITALIZATION-THRESHOLD

    - id: clearing.acceptable_range
      question: "For non-Plooto clearing accounts, should the acceptable balance/range ALWAYS come from KYC/SOP (no defaults), and what is the schema/field for it?"
      status: pending
      answer: "On hold pending KYC access/location confirmation (Google Drive). Treat as KYC-driven with no defaults; if missing, raise an OBP ticket."
      needed_for_rules:
        - BS-CLEARING-ACCOUNTS-WITHIN-CLIENT-THRESHOLD

sources:
  qbo:
    system: quickbooks_online
    retrieval:
      reports:
        balance_sheet:
          endpoint_template: "/v3/company/{realmId}/reports/BalanceSheet?end_date={YYYY-MM-DD}"
        aged_payables_detail:
          endpoint_template: "/v3/company/{realmId}/reports/AgedPayablesDetail?end_date={YYYY-MM-DD}"
        aged_receivables_detail:
          endpoint_template: "/v3/company/{realmId}/reports/AgedReceivablesDetail?end_date={YYYY-MM-DD}"
      entities:
        chart_of_accounts:
          endpoint_template: "/v3/company/{realmId}/query?query=select%20*%20from%20Account"
        journal_entries:
          endpoint_template: "/v3/company/{realmId}/query?query=select%20*%20from%20JournalEntry"
        bills:
          endpoint_template: "/v3/company/{realmId}/query?query=select%20*%20from%20Bill"
        invoices:
          endpoint_template: "/v3/company/{realmId}/query?query=select%20*%20from%20Invoice"
        payments:
          endpoint_template: "/v3/company/{realmId}/query?query=select%20*%20from%20Payment"

  mer_google_sheet:
    system: google_sheets
    role: "review_artifact"

  client_maintenance_kyc:
    system: google_drive_or_sheets
    role: "account_inventory_and_client_specific_thresholds"

  reconciliation_spreadsheet:
    system: google_sheets
    role: "reconciliation_supporting_workpapers"

  plooto:
    system: plooto
    role: "payment_movement_and_clearing_validation"

  dext:
    system: dext
    role: "source_documents_and_publish_metadata"

  tax_portals:
    system: external_portals
    role: "CRA_and_provincial_source_of_truth"

  # Additional standardized source IDs (aligned with bs_v1.yaml conventions)
  qbo_multi_realm:
    system: quickbooks_online
    role: "multi_company_access_for_intercompany_reviews"

  drive_metadata:
    system: google_drive
    role: "file_id_and_metadata_for_link_consistency_checks"

  bank_statements:
    system: external_documents
    role: "bank_statement_pdfs_or_exports_for_reconciliation_evidence"

  credit_card_statements:
    system: external_documents
    role: "credit_card_statement_pdfs_or_exports_for_reconciliation_evidence"

  bank_transactions:
    system: external_documents
    role: "transaction_level_bank_or_card_activity_for_payment_tracing"

  external_platforms:
    system: external_platforms
    role: "wise_ofx_and_other_fx_or_loan_platform_statements_and_access"

rules:
  - rule_id: BS-CLEARING-ACCOUNTS-ZERO
    title: "Clearing accounts should be zero at period end"
    category: deterministic
    automatable: yes
    automation_notes: "Deterministic zero-balance check using QBO Balance Sheet + MER Balance Sheet; relies on label substring matching unless client mapping overrides."
    recommendation: MVP
    what_are_we_testing: "Clearing accounts are expected to clear to $0 at month end (unless a client-specific acceptable range exists in KYC/SOP)."
    source:
      - qbo
      - mer_google_sheet
    matching_against: "Zero balance"
    qbo_only: true
    applies_to:
      qbo_balance_sheet_lines:
        label_contains_any:
          - "clearing"
    parameters:
      tolerance: "0.00"
    evaluation:
      type: balance_sheet_line_items_must_be_zero
    outputs:
      evidence_fields:
        - qbo_line_label
        - qbo_amount
        - mer_line_label
        - mer_amount
        - period_end_date
    edge_cases:
      - "Subaccounts may create multiple matching lines; evaluate each line independently (no aggregation)."
      - "Account naming may vary; client-level mapping can override substring matching."

  - rule_id: BS-UNDEPOSITED-FUNDS-ZERO
    title: "Undeposited Funds should be zero at period end"
    category: deterministic
    automatable: yes
    automation_notes: "Deterministic zero-balance check using QBO Balance Sheet + MER Balance Sheet; relies on label substring matching."
    recommendation: MVP
    what_are_we_testing: "Undeposited funds cleared to deposits by month end."
    source:
      - qbo
      - mer_google_sheet
    matching_against: "Zero balance"
    qbo_only: true
    applies_to:
      qbo_balance_sheet_lines:
        label_contains_any:
          - "undeposited"
    parameters:
      tolerance: "0.00"
    evaluation:
      type: balance_sheet_line_items_must_be_zero
    outputs:
      evidence_fields:
        - qbo_line_label
        - qbo_amount
        - mer_line_label
        - mer_amount
        - period_end_date

  - rule_id: BS-PETTY-CASH-MATCH
    title: "Petty cash matches between MER and QBO"
    category: deterministic
    automatable: yes
    automation_notes: "Deterministic amount match between MER Balance Sheet row and QBO Balance Sheet line. Requires a single unambiguous MER row match."
    recommendation: MVP
    what_are_we_testing: "Petty cash on the MER Balance Sheet matches QBO Balance Sheet as-of the MER period end date."
    source:
      - mer_google_sheet
      - qbo
    matching_against: "Amount match within configured tolerance"
    qbo_only: true
    applies_to:
      qbo_balance_sheet_lines:
        label_contains_any:
          - "petty cash"
    parameters:
      tolerance:
        policy_ref: "policies.tolerances.amount_match"
    evaluation:
      type: mer_line_amount_matches_qbo_line_amount
    outputs:
      evidence_fields:
        - mer_line_label
        - mer_amount
        - qbo_line_label
        - qbo_amount
        - delta
        - period_end_date

  - rule_id: BS-PETTY-CASH-FORMAL-RECONCILE-PRESENT
    title: "Petty cash has a formal reconciliation artifact"
    category: requires_external_evidence
    automatable: partial
    automation_notes: "Requires an agreed reconciliation artifact convention (link/tab) in Sheets/Drive plus client-provided petty cash balance evidence; often needs manual attestation."
    recommendation: MVP
    what_are_we_testing: "When the client provides a petty cash balance to reconcile to (ideally monthly), a formal reconciliation artifact exists (workpaper/tab/link), not just an amount match."
    source:
      - reconciliation_spreadsheet
      - client_maintenance_kyc
      - mer_google_sheet
    matching_against: "Reconciliation artifact present (link or tab)"
    qbo_only: false
    requires_external_sources:
      - reconciliation_spreadsheet
      - client_maintenance_kyc
    manual_attestation_required: true
    evaluation:
      type: support_link_presence_check
    outputs:
      evidence_fields:
        - period_end_date
        - account_name
        - evidence_links
        - reconciliation_artifact_present
    limitations:
      - "Automation may not be able to prove a client-provided petty cash balance exists; treat missing evidence as Needs Human Review unless a configured source provides it."

  - rule_id: BS-BANK-AND-CC-INVENTORY-COVERAGE
    title: "All bank/credit card accounts from maintenance sheet are included"
    category: deterministic
    automatable: partial
    automation_notes: "Deterministic once the maintenance-sheet schema and mapping rules are configured (inventory columns, account-type mapping, and MER row conventions)."
    recommendation: MVP
    what_are_we_testing: "All accounts in the client's 'List of bank accounts and credit cards' inventory exist in QBO and are represented in the MER review package."
    source:
      - client_maintenance_kyc
      - qbo
      - mer_google_sheet
    matching_against: "Presence (account name + type/category mapping)"
    qbo_only: false
    requires_external_sources:
      - client_maintenance_kyc
      - mer_google_sheet
    applies_to:
      account_inventory:
        from: client_maintenance_kyc
        inventory_tab_name: "List of bank accounts and credit cards"
    evaluation:
      type: inventory_accounts_must_exist_in_qbo_and_mer
    outputs:
      evidence_fields:
        - inventory_account_name
        - inventory_account_type
        - qbo_account_id
        - qbo_account_name
        - mer_line_label
        - findings
    limitations:
      - "Exact inventory schema/column names must be configured per your maintenance sheet template."

  - rule_id: BS-BANK-RECONCILED-THROUGH-PERIOD-END
    title: "Bank accounts reconciled through statement date"
    category: requires_external_evidence
    automatable: partial
    automation_notes: "No API-accessible QBO reconciliation status; must be inferred from reconciliation spreadsheets/MER comments and treated as external evidence."
    recommendation: Phase 2
    what_are_we_testing: "Formal reconciliations complete in QBO for all bank accounts with verifiable balances, reconciled to the statement date (through MER period end date where applicable)."
    source:
      - qbo
      - reconciliation_spreadsheet
      - bank_statements
    matching_against: "Statement date / MER period end date"
    qbo_only: false
    requires_external_sources:
      - reconciliation_spreadsheet
      - bank_statements
    evaluation:
      type: requires_external_reconciliation_verification
    outputs:
      evidence_fields:
        - account_name
        - period_end_date
        - statement_date
        - reconciliation_status
        - evidence_links
    limitations:
      - "If QBO reconciliation status is not accessible via your integration, this rule is 'needs_human_review' unless the reconciliation spreadsheet provides proof."

  - rule_id: BS-BANK-BOOK-BALANCE-MATCH
    enabled: true
    title: "(MVP) Bank book balance matches between MER and QBO"
    category: deterministic
    automatable: yes
    automation_notes: "MVP proxy check (book-to-book). Requires configuration of the MER row key and QBO label substring or explicit mapping. Does not prove statement reconciliation."
    recommendation: MVP
    what_are_we_testing: "MVP alternative: compare the MER balance sheet bank line item to the QBO balance sheet bank book balance as-of period end. This does not prove statement reconciliation, so keep disabled by default."
    source:
      - mer_google_sheet
      - qbo
    matching_against: "Equality within configured tolerance"
    qbo_only: false
    parameters:
      # Client mapping may override these defaults.
      mer_bank_row_key: "bank book balance"
      qbo_bank_label_substring: "bank"
      tolerance:
        policy_ref: "policies.tolerances.amount_match"
    evaluation:
      type: mer_bank_balance_matches_qbo_bank_balance
    outputs:
      evidence_fields:
        - period_end_date
        - mer_row_key
        - mer_a1_cell
        - mer_amount
        - qbo_label_substring
        - qbo_first_match_raw
        - qbo_amount
        - delta
        - tolerance
    limitations:
      - "Does not verify statement reconciliation (book balance vs book balance only)."
      - "The default row/label match may be ambiguous; client-specific mapping should override mer_bank_row_key/qbo_bank_label_substring when needed."

  - rule_id: BS-CC-RECONCILED-THROUGH-PERIOD-END
    title: "Credit cards reconciled through statement date"
    category: requires_external_evidence
    automatable: partial
    automation_notes: "No API-accessible QBO reconciliation status; must be inferred from reconciliation spreadsheets/MER comments and treated as external evidence."
    recommendation: Phase 2
    what_are_we_testing: "Formal reconciliations complete in QBO for all credit cards with verifiable balances, reconciled to the statement date."
    source:
      - qbo
      - reconciliation_spreadsheet
      - credit_card_statements
      - client_maintenance_kyc
    matching_against: "Statement date"
    qbo_only: false
    requires_external_sources:
      - reconciliation_spreadsheet
      - client_maintenance_kyc
      - credit_card_statements
    evaluation:
      type: requires_external_reconciliation_verification

  - rule_id: BS-CC-DEBIT-BOOK-BALANCE-MATCH-ALL
    title: "(MVP) Reconcilable account book balances match between MER and QBO"
    category: heuristic
    automatable: yes
    automation_notes: "MVP proxy check (book-to-book) using heuristic account selection and label-based matching; robust MER↔QBO mapping improves accuracy. Does not prove statement reconciliation."
    recommendation: MVP
    what_are_we_testing: "Interim alternative: for all accounts that should be reconciled to an external statement (bank, payment processor/clearing, credit card/LOC), the MER line item matches the QBO book balance as-of period end."
    source:
      - mer_google_sheet
      - qbo
    matching_against: "Equality within configured tolerance"
    qbo_only: false
    parameters:
      # Heuristic selectors for accounts that should be statement-reconciled.
      qbo_include_label_contains_any:
        - "rbc"
        - "bank"
        - "chequing"
        - "checking"
        - "savings"
        - "paypal"
        - "etsy"
        - "clearing"
        - "credit card"
        - "visa"
        - "mastercard"
        - "amex"
        - "discover"
        - "line of credit"
        - "loc"
      # Exclusions: subledger/schedule-driven items (not bank-reconciled).
      qbo_exclude_label_contains_any:
        - "undeposited"
        - "accounts receivable"
        - "a/r"
        - "accounts payable"
        - "a/p"
        - "inventory"
        - "prepaid"
        - "equipment"
        - "furnish"
        - "goodwill"
        - "security deposit"
        - "accumulated"
        - "amortization"
        - "depreciation"
        - "gst"
        - "hst"
        - "pst"
        - "sales tax"
        - "income tax"
        - "accrued"
        - "vacation"
        - "unearned"
        - "wages"
        - "petty cash"
      tolerance:
        policy_ref: "policies.tolerances.amount_match"
    evaluation:
      type: mer_credit_debit_accounts_book_balance_match_qbo
    outputs:
      evidence_fields:
        - period_end_date
        - qbo_label
        - qbo_amount
        - mer_a1_cell
        - mer_amount
        - delta
        - tolerance
    limitations:
      - "Does not verify statement reconciliation (book balance vs book balance only)."
      - "Matching is label-based; if MER row labels differ from QBO account labels, mapping rules will be needed."

  - rule_id: BS-UNCLEARED-ITEMS-INVESTIGATED-AND-FLAGGED
    title: "Uncleared transactions are investigated and explained"
    category: requires_external_evidence
    automatable: partial
    automation_notes: "Requires structured identification of uncleared items in workpapers plus explanation presence; lead flag detection uses '@lead' in the MER Balance Sheet comments column."
    recommendation: MVP
    what_are_we_testing: "Uncleared transactions after reconciliation are investigated, flagged to leads, and have a comment/link in the reconciliation spreadsheet."
    source:
      - reconciliation_spreadsheet
      - client_maintenance_kyc
      - mer_google_sheet
    matching_against: "Presence of explanation (comment/link) + lead flagging (definition TBD)"
    qbo_only: false
    requires_external_sources:
      - reconciliation_spreadsheet
      - client_maintenance_kyc
    parameters:
      explanation_required: true
      explanation_policy_ref: "policies.explanation_definition"
      lead_flagging:
        requires_clarification_ref: "rulebook.requires_clarification.lead_flagging.definition"
    evaluation:
      type: reconciliation_uncleared_items_require_explanation_and_flag
    outputs:
      evidence_fields:
        - account_name
        - uncleared_transaction_identifier
        - uncleared_amount
        - uncleared_date
        - explanation_present
        - explanation_excerpt
        - explanation_link
        - lead_flag_present

  - rule_id: BS-UNCLEARED-ITEMS-COMMENT-WHY-NOT-CONCERN
    title: "Uncleared items include why they are not of concern"
    category: requires_external_evidence
    automatable: partial
    automation_notes: "Requires a defined reconciliation spreadsheet schema for uncleared items and where explanations/comments/links are stored."
    recommendation: MVP
    what_are_we_testing: "For each uncleared item in reconciliation workpapers, there is a comment indicating why it is not of concern (e.g., clears next statement, waiting client info, steps taken, suggested resolution)."
    source:
      - reconciliation_spreadsheet
    matching_against: "Presence of explanation content (comment/link)"
    qbo_only: false
    requires_external_sources:
      - reconciliation_spreadsheet
    parameters:
      explanation_policy_ref: "policies.explanation_definition"
    evaluation:
      type: reconciliation_uncleared_items_require_explanation
    outputs:
      evidence_fields:
        - uncleared_transaction_identifier
        - explanation_present
        - explanation_excerpt

  - rule_id: BS-UNCLEARED-ITEMS-SUGGEST-DUPLICATE-SCAN
    title: "Uncleared items cross-checked vs AP/AR for duplicates"
    category: heuristic
    automatable: partial
    automation_notes: "Heuristic-only; should emit warn/needs_human_review rather than deterministic failures. Requires access to uncleared items list + AP/AR detail context."
    recommendation: Phase 2
    what_are_we_testing: "SOP-expected reviewer step (non-deterministic): compare AP/AR listings to uncleared bank/CC transactions to identify possible duplicates (e.g., cash-coded duplicates)."
    source:
      - qbo
      - reconciliation_spreadsheet
    matching_against: "Potential duplicate signals"
    qbo_only: false
    requires_external_sources:
      - reconciliation_spreadsheet
    sop_expectation:
      required_step: true
      determinism: "non_deterministic_reviewer_guidance"
    evaluation:
      type: heuristic_duplicate_detection
    outputs:
      evidence_fields:
        - suspected_duplicate_pair
        - rationale
    limitations:
      - "This is inherently heuristic and should produce 'warn' / 'needs_human_review' findings, not deterministic failures."

  - rule_id: BS-PLOOTO-CLEARING-ZERO
    title: "Plooto clearing account is zero"
    category: requires_external_evidence
    automatable: partial
    automation_notes: "Detect non-zero balance in QBO; diagnosis requires Plooto transaction report/export and a consistent mapping to the Plooto clearing account in QBO."
    recommendation: Phase 2
    what_are_we_testing: "The Plooto Clearing account should always have a $0 balance."
    source:
      - qbo
      - plooto
    matching_against: "Zero balance"
    qbo_only: false
    requires_external_sources:
      - plooto
    applies_to:
      qbo_balance_sheet_lines:
        requires_client_mapping: true
    parameters:
      tolerance: "0.00"
    evaluation:
      type: balance_sheet_line_items_must_be_zero_with_external_diagnosis
      diagnosis_hints_from_best_practices:
        - "Manual payments made through Plooto not recorded"
        - "Payment failed or not accepted and not recalled into Plooto Instant"
        - "Payment sent and recorded but not yet approved"

  - rule_id: BS-PLOOTO-INSTANT-BALANCE-DISCLOSURE
    title: "Plooto Instant live balance identified"
    category: requires_external_evidence
    automatable: partial
    automation_notes: "Requires Plooto live balance evidence and client KYC context about whether they keep a running float."
    recommendation: Phase 2
    what_are_we_testing: "If there are funds in Plooto Instant, they should be identified for the client (and likely transferred back, depending on client practice)."
    source:
      - plooto
      - client_maintenance_kyc
    matching_against: "Non-zero live balance"
    qbo_only: false
    requires_external_sources:
      - plooto
      - client_maintenance_kyc
    evaluation:
      type: external_live_balance_check

  - rule_id: BS-FX-ACCOUNTS-RECONCILED-MONTHLY
    title: "FX exchange accounts (Wise/OFX/etc.) reconciled monthly"
    category: requires_external_evidence
    automatable: partial
    automation_notes: "Requires statements from FX platform (delegate access) and a reconciliation artifact. Often depends on external platform access and manual evidence capture."
    recommendation: Phase 2
    what_are_we_testing: "Foreign currency exchange accounts are reconciled at month end using downloaded statements (delegate access expected)."
    source:
      - qbo
      - external_platforms
      - client_maintenance_kyc
    matching_against: "Statement ending balances and reconciliation evidence"
    qbo_only: false
    requires_external_sources:
      - client_maintenance_kyc
      - external_platforms
    evaluation:
      type: requires_external_statement_reconciliation

  - rule_id: BS-FX-DELEGATE-ACCESS-ATTESTED
    title: "Wise/OFX delegate access confirmed"
    category: human_review
    automatable: no
    automation_notes: "Delegate access is typically not API-verifiable in this workflow; requires manual attestation and evidence link."
    recommendation: Never
    what_are_we_testing: "SOP expectation: Enkel should have delegate access to Wise/OFX (or equivalent FX platforms) used by the client. If automation cannot verify access existence, require manual attestation and record where access was confirmed."
    source:
      - external_platforms
      - client_maintenance_kyc
    matching_against: "Delegate access confirmed"
    qbo_only: false
    requires_external_sources:
      - client_maintenance_kyc
      - external_platforms
    manual_attestation_required: true
    evaluation:
      type: needs_human_judgment
    outputs:
      evidence_fields:
        - period_end_date
        - platform
        - delegate_access_confirmed
        - evidence_links
    limitations:
      - "Access existence is typically not API-verifiable in this workflow; treat as a manual control/attestation step."

  - rule_id: BS-AP-SUBLEDGER-RECONCILES
    title: "Aged Payables Detail reconciles to Balance Sheet"
    category: deterministic
    automatable: yes
    automation_notes: "Deterministic if QBO Reports API access is available (Aged Payables Detail + Balance Sheet)."
    recommendation: MVP
    what_are_we_testing: "Aged Payables Detail total reconciles to the Accounts Payable balance sheet account at period end."
    source:
      - qbo
    matching_against: "Equality within configured tolerance"
    qbo_only: true
    parameters:
      tolerance:
        policy_ref: "policies.tolerances.amount_match"
    evaluation:
      type: qbo_report_total_matches_balance_sheet_line
      qbo_reports_required:
        - aged_payables_detail
        - balance_sheet

  - rule_id: BS-AR-SUBLEDGER-RECONCILES
    title: "Aged Receivables Detail reconciles to Balance Sheet"
    category: deterministic
    automatable: yes
    automation_notes: "Deterministic if QBO Reports API access is available (Aged Receivables Detail + Balance Sheet)."
    recommendation: MVP
    what_are_we_testing: "Aged Receivables Detail total reconciles to the Accounts Receivable balance sheet account at period end."
    source:
      - qbo
    matching_against: "Equality within configured tolerance"
    qbo_only: true
    parameters:
      tolerance:
        policy_ref: "policies.tolerances.amount_match"
    evaluation:
      type: qbo_report_total_matches_balance_sheet_line
      qbo_reports_required:
        - aged_receivables_detail
        - balance_sheet

  - rule_id: BS-AP-AR-ITEMS-OLDER-THAN-60-DAYS
    title: "AP/AR items older than 60 days flagged"
    category: deterministic
    automatable: partial
    automation_notes: "Deterministic detection of >60-day open items via QBO aging reports; explanation/comment/link presence still requires a defined comment location and validation."
    recommendation: MVP
    what_are_we_testing: "Any open bills/invoices/payments older than 60 days are identified and require a comment/link."
    source:
      - qbo
      - mer_google_sheet
    matching_against: "Age > 60 days"
    qbo_only: true
    sop_expectation:
      required_step: true
      determinism: deterministic_detection_requires_manual_explanation
    parameters:
      max_age_days: 60
      explanation_policy_ref: "policies.explanation_definition"
    evaluation:
      type: qbo_aging_items_older_than_threshold_require_explanation

  - rule_id: BS-AP-AR-NEGATIVE-OPEN-ITEMS
    title: "Negative items (credits/overpayments) identified and justified"
    category: requires_external_evidence
    automatable: partial
    automation_notes: "Detection is deterministic; justification requires linked source documentation (e.g., Dext/statement evidence) and often human confirmation."
    recommendation: MVP
    what_are_we_testing: "Negative open AP/AR items exist only with justification (source documentation, credit application status, refund confirmation, and no duplicate cash-coding)."
    source:
      - qbo
      - dext
      - bank_transactions
    matching_against: "Open amount < 0"
    qbo_only: false
    requires_external_sources:
      - dext
      - bank_transactions
    evaluation:
      type: detect_negative_open_items_and_require_external_justification

  - rule_id: BS-AP-AR-PAID-BUT-STILL-OPEN
    title: "Paid-or-likely-paid transactions still open are flagged"
    category: heuristic
    automatable: partial
    automation_notes: "Heuristic signal detection (e.g., RB9 references) can flag candidates, but confirming payment evidence/matching requires external docs and reviewer judgment."
    recommendation: Phase 2
    what_are_we_testing: "Bills/invoices that appear paid (e.g., payment references on source docs) but remain open in AP/AR are flagged for investigation and explanation."
    source:
      - qbo
      - dext
      - bank_transactions
    matching_against: "Heuristic signals (payment references, known patterns)"
    qbo_only: false
    requires_external_sources:
      - dext
      - bank_transactions
    parameters:
      heuristics:
        rb9_reference_prefix:
          enabled: false
          requires_client_confirmation: true
          pattern: "^RB9"
    evaluation:
      type: heuristic_paid_but_open_detection

  - rule_id: BS-AP-AR-INTERCOMPANY-OR-SHAREHOLDER-PAID
    title: "Items paid by intercompany/shareholder loan identified"
    category: requires_external_evidence
    automatable: partial
    automation_notes: "Requires multi-entity context (related company access, account mappings) and/or structured KYC data describing intercompany/shareholder loan workflows."
    recommendation: Phase 2
    what_are_we_testing: "Transactions paid by related companies or via shareholder loan are identified so open AP/AR can be cleared appropriately and intercompany balances remain consistent."
    source:
      - qbo_multi_realm
      - client_maintenance_kyc
    matching_against: "Evidence of payment in other entity / loan account postings"
    qbo_only: false
    requires_external_sources:
      - client_maintenance_kyc
    evaluation:
      type: multi_entity_payment_trace

  - rule_id: BS-AP-AR-FOREIGN-CURRENCY-DISCREPANCIES
    title: "Foreign currency discrepancies on AP/AR addressed"
    category: requires_external_evidence
    automatable: partial
    automation_notes: "Requires multi-currency context and often statement evidence; edge cases are judgment-heavy (FX rate application, cash-coding duplicates)."
    recommendation: Phase 2
    what_are_we_testing: "Foreign currency bills paid with another currency are checked for exchange-rate application issues, over/underpayment artifacts, and matching feasibility."
    source:
      - qbo
      - credit_card_statements
      - client_maintenance_kyc
    matching_against: "Currency mismatch / revaluation artifacts"
    qbo_only: false
    requires_external_sources:
      - client_maintenance_kyc
      - credit_card_statements
    evaluation:
      type: fx_ap_ar_exception_review

  - rule_id: BS-AP-AR-NEW-OVERDUE-ITEMS
    title: "Newly entered but already overdue items flagged"
    category: human_review
    automatable: partial
    automation_notes: "Requires prior-cycle reference and client context to determine whether an overdue item is newly introduced vs previously known."
    recommendation: Phase 2
    what_are_we_testing: "If new bills were provided since last AP cycle and were already overdue, they are flagged internally and to the client."
    source:
      - qbo
      - client_maintenance_kyc
    matching_against: "Due date already past at time of entry"
    qbo_only: false
    requires_external_sources:
      - client_maintenance_kyc
    evaluation:
      type: needs_prior_cycle_context

  - rule_id: BS-AP-ENKEL-BILLS
    title: "Bills from Enkel investigated"
    category: human_review
    automatable: no
    automation_notes: "Requires an internal process (#billing escalation) and confirmation of payment status; automation can only flag candidates."
    recommendation: Never
    what_are_we_testing: "If bills from Enkel appear in AP, request made in #billing to determine whether unpaid and alert billing team."
    source:
      - qbo
    matching_against: "Vendor name matches 'Enkel' (client-configurable)"
    qbo_only: false
    evaluation:
      type: manual_process_required
    parameters:
      vendor_name_match:
        requires_client_mapping: true

  - rule_id: BS-AP-AR-YEAR_END_BATCH_ADJUSTMENTS
    title: "Year-end AP/AR batch adjustments not left as generic supplier/customer"
    category: requires_external_evidence
    automatable: partial
    automation_notes: "Can detect suspicious journal entries impacting AP/AR; validating breakdown/support requires external communications or linked workpapers."
    recommendation: MVP
    what_are_we_testing: "Year-end accountants' batch adjustments to AP/AR are not entered as generic supplier/customer without breakdown; uncleared batch adjustments are investigated and flagged."
    source:
      - qbo
      - mer_google_sheet
    matching_against: "Journal entries impacting AP/AR with insufficient transaction-level breakdown"
    qbo_only: false
    requires_external_sources:
      - mer_google_sheet
    evaluation:
      type: detect_ap_ar_batch_adjustments_and_require_breakdown

  - rule_id: BS-AP-AR-PAID-AFTER-MONTH-END-NOTED
    title: "Items paid after month-end are annotated in MER"
    category: deterministic
    automatable: partial
    automation_notes: "Deterministic payment-date detection in QBO is possible; enforcing/validating that MER comments include payment date/method requires consistent comment fields in Sheets."
    recommendation: MVP
    what_are_we_testing: "When delivering MER, items paid after month-end have comments with payment date/method."
    source:
      - qbo
      - mer_google_sheet
    matching_against: "Payment date > MER period end"
    qbo_only: false
    requires_external_sources:
      - mer_google_sheet
    parameters:
      explanation_policy_ref: "policies.explanation_definition"
    evaluation:
      type: payments_after_period_end_require_mer_annotation

  - rule_id: BS-INTERCOMPANY-BALANCES-RECONCILE
    title: "Intercompany loan balances reconcile across related companies"
    category: requires_external_evidence
    automatable: partial
    automation_notes: "Requires access to all related companies (multiple realmIds) and mapping of intercompany loan accounts between entities; sign inversion may be required."
    recommendation: Phase 2
    what_are_we_testing: "If bookkeeping is done for related companies, intercompany loan balances reconcile between both entities."
    source:
      - qbo_multi_realm
    matching_against: "Balance equality (sign-inverted as appropriate)"
    qbo_only: false
    evaluation:
      type: multi_company_balance_reconciliation

  - rule_id: BS-INTERCOMPANY-FORMAL-RECONCILE-IF-EOM-BALANCE
    title: "Intercompany loan formally reconciled if EOM balance provided"
    category: requires_external_evidence
    automatable: partial
    automation_notes: "No API-accessible QBO reconciliation status; must be inferred from reconciliation spreadsheets/MER evidence and treated as external evidence."
    recommendation: Phase 2
    what_are_we_testing: "If an end-of-month balance is available for an intercompany loan, the account is formally reconciled in both/all QBO companies."
    source:
      - qbo_multi_realm
      - reconciliation_spreadsheet
    matching_against: "Formal reconciliation completed"
    qbo_only: false
    requires_external_sources:
      - reconciliation_spreadsheet
    evaluation:
      type: requires_external_reconciliation_verification

  - rule_id: BS-INTERCOMPANY-VARIANCE-DISCLOSED
    title: "Intercompany discrepancies included in reconciliation spreadsheet"
    category: requires_external_evidence
    automatable: partial
    automation_notes: "Requires reconciliation spreadsheet conventions for documenting variances and explanations."
    recommendation: MVP
    what_are_we_testing: "Any unresolved discrepancies are included as intercompany loan variance in the bank reconciliation spreadsheet."
    source:
      - reconciliation_spreadsheet
    matching_against: "Presence of variance line item + explanation"
    qbo_only: false
    requires_external_sources:
      - reconciliation_spreadsheet
    parameters:
      explanation_policy_ref: "policies.explanation_definition"
    evaluation:
      type: variance_must_be_documented

  - rule_id: BS-WORKING-PAPER-RECONCILES
    title: "Working papers reconcile to Balance Sheet"
    category: requires_external_evidence
    automatable: partial
    automation_notes: "Requires working paper balances in Sheets (or linked) and a reliable mapping from working paper to QBO Balance Sheet line(s)."
    recommendation: MVP
    what_are_we_testing: "Working paper balances reconcile to the financial statements (Balance Sheet lines)."
    source:
      - reconciliation_spreadsheet
      - mer_google_sheet
      - qbo
    matching_against: "Amount match within configured tolerance"
    qbo_only: false
    requires_external_sources:
      - reconciliation_spreadsheet
      - mer_google_sheet
    parameters:
      tolerance:
        policy_ref: "policies.tolerances.amount_match"
    evaluation:
      type: working_paper_balance_matches_qbo_balance_sheet

  - rule_id: BS-WORKING-PAPER-LINKS-PRESENT-IN-MER
    title: "Links to working papers included in Balance Sheet report"
    category: deterministic
    automatable: yes
    automation_notes: "Deterministic presence check for hyperlinks in MER Balance Sheet lines (given stable link conventions)."
    recommendation: MVP
    what_are_we_testing: "Balance Sheet lines with working papers include links to the relevant working papers in the MER review package."
    source:
      - mer_google_sheet
    matching_against: "Link present"
    qbo_only: false
    requires_external_sources:
      - mer_google_sheet
    evaluation:
      type: mer_lines_require_link_to_support

  - rule_id: BS-MONTH-END-JOURNALS-FROM-KYC-PROCESSED
    title: "KYC-specified month-end journals processed"
    category: requires_external_evidence
    automatable: partial
    automation_notes: "Requires structured KYC fields enumerating required month-end journals and a mapping to detectable QBO Journal Entry patterns."
    recommendation: Phase 2
    what_are_we_testing: "Specific month-end journals required by the client’s KYC are processed for the period."
    source:
      - client_maintenance_kyc
      - qbo
    matching_against: "Presence of required journals"
    qbo_only: false
    requires_external_sources:
      - client_maintenance_kyc
    evaluation:
      type: required_journals_present

  - rule_id: BS-WORKING-PAPER-HAS-CHECK-FORMULA
    title: "Working papers contain a check formula vs QBO"
    category: deterministic
    automatable: yes
    automation_notes: "Deterministic if your working paper template has a consistent variance/check formula pattern that can be scanned in Sheets."
    recommendation: MVP
    what_are_we_testing: "Working papers include a check formula adding the QBO balance and calculating variance."
    source:
      - reconciliation_spreadsheet
    matching_against: "Presence of check formula / variance cell"
    qbo_only: false
    requires_external_sources:
      - reconciliation_spreadsheet
    evaluation:
      type: working_paper_integrity_check

  - rule_id: BS-WORKING-PAPER-SINGLE-COPY-REUSED
    title: "Single working paper reused monthly"
    category: requires_external_evidence
    automatable: partial
    automation_notes: "Requires stable Drive file IDs or link metadata across periods to detect whether the same working paper is reused."
    recommendation: Phase 2
    what_are_we_testing: "There is one working paper referenced every month (not copied each month)."
    source:
      - drive_metadata
      - mer_google_sheet
    matching_against: "Consistent file ID / link target across months"
    qbo_only: false
    requires_external_sources:
      - mer_google_sheet
      - drive_metadata
    evaluation:
      type: working_paper_link_consistency

  - rule_id: BS-TAX-FILINGS-UP-TO-DATE
    title: "Sales tax filings completed through most recent period"
    category: requires_external_evidence
    automatable: partial
    automation_notes: "Requires QBO tax filings access (if available) or external portal evidence (CRA/provincial)."
    recommendation: Phase 2
    what_are_we_testing: "Sales tax filings have been made in QBO until the most recent period."
    source:
      - qbo
      - tax_portals
    matching_against: "Most recent period"
    qbo_only: false
    requires_external_sources:
      - tax_portals
    evaluation:
      type: requires_external_tax_filing_verification

  - rule_id: BS-TAX-PAYABLE-AND-SUSPENSE-RECONCILE-TO-RETURN
    title: "Tax payable/suspense reconcile to most recent return"
    category: requires_external_evidence
    automatable: partial
    automation_notes: "Requires return evidence (portal/export) and mapping of payments/refunds to suspense/payable accounts."
    recommendation: Phase 2
    what_are_we_testing: "Payable and suspense accounts reconcile to current/most recent return; payments/refunds offset the relevant tax suspense account."
    source:
      - qbo
      - tax_portals
    matching_against: "Return balances"
    qbo_only: false
    requires_external_sources:
      - tax_portals
    evaluation:
      type: tax_accounts_reconcile

  - rule_id: BS-TAX-PAYABLE-MATCHES-PORTAL
    title: "Tax payable matches CRA/provincial portal balances"
    category: requires_external_evidence
    automatable: partial
    automation_notes: "Requires external portal balances (CRA/provincial) and a mapping between portal liabilities and QBO accounts."
    recommendation: Phase 2
    what_are_we_testing: "Payable accounts reconcile to balances owing as shown on CRA/provincial tax websites."
    source:
      - tax_portals
      - qbo
    matching_against: "Portal balance"
    qbo_only: false
    requires_external_sources:
      - tax_portals
    evaluation:
      type: external_authority_balance_match

  - rule_id: BS-TAX-INTEREST-PENALTIES-RECORDED
    title: "Tax interest/penalties recorded and payments matched"
    category: requires_external_evidence
    automatable: partial
    automation_notes: "Requires external notices and confirmation that QBO transactions match payment application; often needs manual review."
    recommendation: Phase 2
    what_are_we_testing: "Any interest/penalties are recorded and payments matched correctly."
    source:
      - qbo
      - tax_portals
    matching_against: "Payment application evidence"
    qbo_only: false
    requires_external_sources:
      - tax_portals
    evaluation:
      type: requires_external_notice_verification

  - rule_id: BS-TAX-MISCLASSIFICATION-CHECK
    title: "Taxes not recorded to wrong accounts"
    category: deterministic
    automatable: partial
    automation_notes: "Deterministic only with explicit account mapping rules (what constitutes misclassification for each client)."
    recommendation: Phase 2
    what_are_we_testing: "Taxes haven’t been recorded to the wrong account (e.g., corporate tax instalments incorrectly recorded to a sales tax account)."
    source:
      - qbo
    matching_against: "Account mapping rules"
    qbo_only: true
    evaluation:
      type: detect_tax_misclassification

  - rule_id: BS-LOAN-AND-INVESTMENT-BALANCES-RECONCILE
    title: "Loans/investments reconcile to statements or schedules"
    category: requires_external_evidence
    automatable: partial
    automation_notes: "Requires statements/schedules (often external) and a mapping between schedule balances and QBO Balance Sheet accounts."
    recommendation: Phase 2
    what_are_we_testing: "Loan and investment balances reconcile to statements or an interest/repayment schedule when available."
    source:
      - external_platforms
      - client_maintenance_kyc
      - qbo
    matching_against: "Statement ending balance / schedule balance"
    qbo_only: false
    requires_external_sources:
      - client_maintenance_kyc
      - external_platforms
    parameters:
      tolerance:
        policy_ref: "policies.tolerances.amount_match"
    evaluation:
      type: external_statement_balance_match

  - rule_id: BS-LOAN-SCHEDULE-LINKS-PRESENT
    title: "Interest/repayment schedules linked when available"
    category: requires_external_evidence
    automatable: partial
    automation_notes: "Requires link presence conventions and (optionally) Drive metadata to confirm the referenced schedule exists and is current."
    recommendation: Phase 2
    what_are_we_testing: "Link to interest/repayment schedule is included if enough info exists to make one."
    source:
      - mer_google_sheet
      - drive_metadata
    matching_against: "Link present"
    qbo_only: false
    requires_external_sources:
      - mer_google_sheet
      - drive_metadata
    evaluation:
      type: support_link_presence_check

  - rule_id: BS-LOAN-MISSING-INFO-FLAGGED
    title: "Missing info/new loans flagged to reviewer"
    category: human_review
    automatable: no
    automation_notes: "Determining whether info is missing/new is subjective without a structured client asset register and prior-cycle context; keep as reviewer judgment."
    recommendation: Never
    what_are_we_testing: "If information is missing or new loans/investments appear, the reviewer is flagged."
    source:
      - qbo
      - external_platforms
    matching_against: "Missing support"
    qbo_only: false
    evaluation:
      type: needs_human_judgment

  - rule_id: BS-CLEARING-ACCOUNTS-WITHIN-CLIENT-THRESHOLD
    title: "Clearing accounts within client-specific acceptable range"
    category: requires_external_evidence
    automatable: partial
    automation_notes: "Requires client-specific thresholds from KYC/SOP (no defaults). If missing, raise OBP ticket; pending KYC access."
    recommendation: Phase 2
    what_are_we_testing: "Clearing accounts are within the acceptable balance/range documented in client KYC/SOP."
    source:
      - client_maintenance_kyc
      - qbo
    matching_against: "Client-specific thresholds"
    qbo_only: false
    requires_external_sources:
      - client_maintenance_kyc
    process_actions:
      on_missing_threshold_documentation:
        action: "raise_obp_ticket"
        reason: "Client acceptable clearing range is required in KYC/SOP; create OBP ticket when missing so the range can be captured/confirmed."
    evaluation:
      type: balance_within_configured_range

  - rule_id: BS-CLEARING-ACCOUNTS-CONSISTENCY-ACROSS-MONTHS
    title: "Clearing account balances reviewed for consistency across months"
    category: heuristic
    automatable: yes
    automation_notes: "Requires multi-period balance history and client-configurable variance thresholds; produces warnings rather than deterministic failures."
    recommendation: Phase 2
    what_are_we_testing: "Clearing accounts are reviewed for consistency across months (unusual changes flagged)."
    source:
      - qbo
      - client_maintenance_kyc
    matching_against: "Variance thresholds"
    qbo_only: false
    requires_external_sources:
      - client_maintenance_kyc
    evaluation:
      type: multi_period_variance_review

  - rule_id: BS-FIXED-ASSET-CAPITALIZATION-THRESHOLD
    title: "Capitalization threshold enforced"
    category: requires_external_evidence
    automatable: partial
    automation_notes: "Default threshold is $1,000 unless KYC overrides. Automating capitalization requires classification rules to detect capital purchases and review journal posting behavior."
    recommendation: Phase 2
    what_are_we_testing: "New transactions are reviewed so items above the capitalization threshold are capitalized (threshold is client SOP-defined)."
    source:
      - client_maintenance_kyc
      - qbo
    matching_against: "Threshold amount"
    qbo_only: false
    requires_external_sources:
      - client_maintenance_kyc
    evaluation:
      type: fixed_asset_capitalization_review

  - rule_id: BS-FIXED-ASSET-REGISTER-RECONCILES
    title: "Fixed asset register reconciles to Balance Sheet"
    category: requires_external_evidence
    automatable: partial
    automation_notes: "Requires a fixed asset register/depreciation schedule (Sheets/Drive) and a mapping to QBO fixed asset balances."
    recommendation: Phase 2
    what_are_we_testing: "Depreciation schedule and/or fixed asset register is reviewed, updated, reconciled to QBO, and linked in delivery file."
    source:
      - mer_google_sheet
      - drive_metadata
      - qbo
    matching_against: "Net book value match"
    qbo_only: false
    requires_external_sources:
      - mer_google_sheet
      - drive_metadata
    parameters:
      tolerance:
        policy_ref: "policies.tolerances.amount_match"
    evaluation:
      type: external_register_balance_match

  - rule_id: BS-FIXED-ASSET-CLIENT-CODING-REVIEW
    title: "Client coding reviewed for expensing vs capitalizing"
    category: human_review
    automatable: no
    automation_notes: "Subjective reviewer judgment about appropriate accounting treatment; automation can only surface candidates for review."
    recommendation: Never
    what_are_we_testing: "If client coded items and reviewer believes something should be expensed instead of capitalized, it is flagged to reviewer."
    source:
      - qbo
    matching_against: "N/A"
    qbo_only: true
    evaluation:
      type: needs_human_judgment
